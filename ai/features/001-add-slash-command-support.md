---
description: Автоматическая установка файла slash-команды для инструмента rate-limit-status
type: feature
priority: high
status: ready
---

# Автоматическая установка Slash-команды для rate-limit-status

## Описание проблемы

В README плагина `opencode-rate-limit` указано:
> Используйте команду `/rate-limit-status` в OpenCode (если поддерживается вашим TUI) для получения отчёта в формате Markdown...

Однако slash-команда `/rate-limit-status` не появляется в списке команд TUI.

## Анализ причин

1. Плагин правильно регистрирует **инструмент (tool)** с именем `rate-limit-status` в `index.ts`:
    ```typescript
    tool: {
      "rate-limit-status": tool({
        description: "Показать подробную статистику лимитов...",
        args: {},
        async execute() {
          return statusReporter.getFullReport();
        },
      }),
    },
    ```

2. **Инструменты (Tools)**, регистрируемые через систему плагинов, это MCP-инструменты, которые могут вызывать AI агенты, а не slash-команды, которые пользователи могут вводить в TUI.

3. **Slash-команды** в OpenCode - это Markdown файлы в `~/.config/opencode/commands/` (например, `pa-research.md`, `pa-check.md`).

4. Плагин не создаёт файл slash-команды по пути `~/.config/opencode/commands/rate-limit-status.md`.

5. В `@opencode-ai/plugin` v1.2.4 нет задокументированного механизма для программной регистрации slash-команд плагинами.

## Влияние

- Пользователи не могут вызвать `/rate-limit-status` из TUI
- Инструмент доступен только когда AI агенты решают его вызвать
- Это противоречит документации в README.md

## Возможные решения

### Вариант A: Ручное решение (Пользователь)
Создать файл `~/.config/opencode/commands/rate-limit-status.md` вручную:

```yaml
---
description: Показать статистику rate limits, здоровье моделей и прогноз до следующей блокировки
---

Используй инструмент rate-limit-status для отображения:
- Текущий статус здоровья моделей (health score)
- Статистику rate limits для каждой модели
- Статистику fallbacks (переключений между моделями)
- Статистику ретраев (повторных попыток)
- Прогноз до следующей возможной блокировки по rate limit

Инструмент вернёт форматированный Markdown отчёт со всей информацией.
```

### Вариант B: Плагин создаёт файл команды
Добавить логику в инициализацию плагина для записи `rate-limit-status.md` в `~/.config/opencode/commands/`, если он не существует.

**Преимущества:**
- Автоматическое, без вмешательства пользователя
- Согласуется с документацией в README

**Недостатки:**
- Может требовать прав доступа к файловой системе
- Необходимо корректно обрабатывать существующие файлы команд
- Сложность жизненного цикла установки/обновления

### Вариант C: Автоматическая регистрация инструментов как команд
Расширить систему плагинов OpenCode для автоматического создания slash-команд для зарегистрированных инструментов (аналогично работе MCP-инструментов).

**Преимущества:**
- Чистое решение, объединяет концепции инструмента и команды
- Работает для всех плагинов автоматически

**Недостатки:**
- Требует изменений в ядре OpenCode
- Неосуществимо для одного плагина

### Вариант D: Использование инструмента через AI
Документировать, что инструмент должен использоваться через запрос к AI вызвать его:

> "Покажи мне текущий статус rate limit"

Это использует существующую регистрацию инструмента без необходимости slash-команд.

## Рекомендуемое решение

**Выбрано:** Вариант B (Плагин создаёт файл команды)

Плагин будет автоматически создавать файл slash-команды при инициализации. Это обеспечит готовый функционал "из коробки" без необходимости ручных действий пользователя.

## Исследование

**Источники:**
- `~/.config/opencode/commands/` - Структура директории slash-команд OpenCode
- `/Users/deniszaplakhov/projects/plugin-opencode-rate-limit/index.ts` - Текущая инициализация плагина
- `/Users/deniszaplakhov/projects/plugin-opencode-rate-limit/package.json` - Конфигурация сборки и публикации

**Ключевые выводы:**
1. Slash-команды OpenCode - это Markdown файлы в `~/.config/opencode/commands/`
2. Инициализация плагина происходит в `index.ts` через основную async-функцию
3. Команды могут вызывать инструменты по их именам
4. Сборка пакета использует компиляцию TypeScript и включает файлы `dist/**/*.js`

## Критерии приёмки

1. Плагин автоматически создаёт `~/.config/opencode/commands/rate-limit-status.md` при первой инициализации
2. Slash-команда `/rate-limit-status` появляется в списке команд TUI после загрузки плагина
3. Выполнение команды вызывает существующий инструмент `rate-limit-status` и отображает его вывод
4. В README.md больше не упоминается "если поддерживается вашим TUI"
5. Существующие файлы команд не перезаписываются (идемпотентная операция)
6. Логи установки чётко указывают на успех/неудачу установки команды
7. Пакет может быть собран и опубликован в npm

## Детальный план реализации

### Этап 1: Создание модуля CommandInstaller

1. Создать `src/installer/CommandInstaller.ts`:
    ```typescript
    export class CommandInstaller {
      async install(): Promise<{ success: boolean; path?: string; error?: string }>
      isInstalled(): boolean
      getCommandPath(): string
      async uninstall(): Promise<{ success: boolean; error?: string }>
    }
    ```
    - Путь файла команды: `~/.config/opencode/commands/rate-limit-status.md`
    - Содержимое команды указывает AI вызвать инструмент `rate-limit-status`
    - Создаёт директорию при необходимости
    - Пропускает установку если файл уже существует (идемпотентно)
    - Корректная обработка ошибок и логирование

### Этап 2: Интеграция установщика в инициализацию плагина

Изменить `index.ts`:
1. Импортировать класс `CommandInstaller`
2. Создать экземпляр после создания логгера
3. Вызвать `install()` во время инициализации плагина
4. Логировать сообщения об успехе/предупреждении соответствующим образом
5. Грациозно обрабатывать сбои установки (плагин должен продолжать работать)

### Этап 3: Обновление документации

Изменить `README.md`:
1. Убрать оговорку "если поддерживается вашим TUI"
2. Обновить секцию использования команды с более уверенной формулировкой
3. Добавить примечание об автоматической установке команды

### Этап 4: Сборка и тестирование

1. Запустить `npm run clean` для удаления старой сборки
2. Запустить `npm run build` для компиляции TypeScript
3. Проверить артефакты сборки в `dist/`
4. Протестировать загрузку плагина в локальном OpenCode
5. Проверить что `/rate-limit-status` появляется в TUI
6. Проверить что выполнение команды работает корректно

### Этап 5: Публикация в npm

1. Обновить версию в `package.json` до `1.2.0` (semver minor для новой функции)
2. Запустить `npm publish`
3. Проверить что пакет появился в реестре npm

## Явный Allowlist

**Файлы для создания:**
- `src/installer/CommandInstaller.ts` - Модуль установщика команд
- `dist/installer/CommandInstaller.js` - Скомпилированный выход
- `dist/installer/CommandInstaller.d.ts` - Определения TypeScript

**Файлы для изменения:**
- `index.ts` - Интеграция CommandInstaller в инициализацию
- `README.md` - Обновление документации

**Файлы только для чтения (для контекста):**
- `package.json` - Скрипты сборки и версия
- `src/tui/StatusReporter.ts` - Понимание формата вывода инструмента
- `~/.config/opencode/commands/*` - Справочник формата файла команды

## Связанные файлы

- `index.ts` - Точка входа плагина с регистрацией инструментов
- `src/installer/CommandInstaller.ts` - Модуль установщика команд (НОВЫЙ)
- `README.md` - Документация с упоминанием `/rate-limit-status`
- `src/tui/StatusReporter.ts` - Реализация инструмента
- `~/.config/opencode/commands/` - Директория команд OpenCode

## Заметки по реализации

- Использовать модули Node.js `fs` и `path` для файловых операций
- Содержимое команды в формате Markdown с YAML frontmatter для `description`
- Установка должна быть неблокирующей - плагин работает даже если установка команды не удалась
- Файл команды должен содержать инструкцию AI вызвать инструмент, а не вызывать его напрямую
