# opencode-rate-limit

[![npm version](https://badge.fury.io/js/opencode-rate-limit.svg)](https://www.npmjs.com/package/opencode-rate-limit)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

–ü–ª–∞–≥–∏–Ω –¥–ª—è [OpenCode](https://github.com/nichochar/opencode), –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limit). –§–æ—Ä–∫ –ø—Ä–æ–µ–∫—Ç–∞ [@azumag/opencode-rate-limit-fallback](https://github.com/azumag/opencode-rate-limit-fallback) —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ rate limit (429, "usage limit", "quota exceeded", "high concurrency") –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –º–æ–¥–µ–ª—å
- üìã **–°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º** ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
- üîÅ **–¢—Ä–∏ —Ä–µ–∂–∏–º–∞ fallback** ‚Äî `cycle` (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä), `stop` (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞) –∏ `retry-last` (–ø–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–µ–ª–∏)
- ü§ñ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞/—Ä–µ–∂–∏–º–∞** ‚Äî –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –∞–≥–µ–Ω—Ç (plan, build –∏ —Ç.–¥.)
- ‚è±Ô∏è **Cooldown** ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
- üìä **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff** ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ immediate, exponential, linear —Å jitter
- üîå **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–ø–∞–≥–∞—Ü–∏—è fallback –ø–æ –∏–µ—Ä–∞—Ä—Ö–∏–∏ —Å–µ—Å—Å–∏–π
- ‚ö° **Circuit Breaker** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø–∞–¥–∞—é—â–∏—Ö –º–æ–¥–µ–ª–µ–π
- üìà **–°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫** ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ rate limit, fallback, retry –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π
- üîÉ **Hot Reload** ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ OpenCode
- üß† **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ø–æ success rate, response time –∏ —á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- üè• **Health Tracker** ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
- üìö **Pattern Learning** ‚Äî –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –æ—à–∏–±–∫–∞—Ö –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ rate limit
- üîí **Event Lock —Å TTL** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö

## –û—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏

–î–∞–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω —è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ñ–æ—Ä–∫–æ–º [`@azumag/opencode-rate-limit-fallback`](https://github.com/azumag/opencode-rate-limit-fallback). –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è:

| –§—É–Ω–∫—Ü–∏—è | –û—Ä–∏–≥–∏–Ω–∞–ª | opencode-rate-limit |
|---------|----------|---------------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª | 12 –º–æ–¥—É–ª–µ–π (circuitbreaker, config, diagnostics, dynamic, errors, fallback, health, main, metrics, retry, session, utils) |
| –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | Event Lock —Å TTL (10 —Å–µ–∫) ‚Äî –µ–¥–∏–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å–µ—Å—Å–∏—é |
| Circuit Breaker | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π CB —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ CLOSED ‚Üí OPEN ‚Üí HALF_OPEN |
| Hot Reload –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–æ—Ä–¥–µ—Ä–∏–Ω–≥ –ø–æ score (success rate √ó 0.6 + response time √ó 0.3 + usage √ó 0.1) |
| Health Tracker | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π |
| Pattern Learning | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫ rate limit |
| –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | DiagnosticReporter —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å—é |
| –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ | –ë–∞–∑–æ–≤–∞—è | ConfigValidator —Å–æ —Å—Ç—Ä–æ–≥–∏–º —Ä–µ–∂–∏–º–æ–º (strict mode) |
| –¢–µ—Å—Ç—ã | –†—É—á–Ω–æ–π —Å–∫—Ä–∏–ø—Ç | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ unit-—Ç–µ—Å—Ç—ã –Ω–∞ Vitest |

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ß–µ—Ä–µ–∑ npm (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
npm install opencode-rate-limit
```

### –ß–µ—Ä–µ–∑ GitHub

```bash
npm install github:zaplakhov/opencode-rate-limit
```

### –ò–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤

```bash
git clone https://github.com/zaplakhov/opencode-rate-limit.git
cd opencode-rate-limit
npm install
npm run build
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OpenCode

–î–æ–±–∞–≤—å—Ç–µ –ø–ª–∞–≥–∏–Ω –≤ –≤–∞—à `opencode.json`:

```json
{
  "plugins": ["opencode-rate-limit"]
}
```

OpenCode –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç –ø–ª–∞–≥–∏–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–π (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

1. `<worktree>/.opencode/rate-limit-fallback.json`
2. `<worktree>/rate-limit-fallback.json`
3. `<project>/.opencode/rate-limit-fallback.json`
4. `<project>/rate-limit-fallback.json`
5. `~/.opencode/rate-limit-fallback.json` *(—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)*
6. `~/.config/opencode/rate-limit-fallback.json`

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```json
{
  "fallbackModels": [
    { "providerID": "anthropic", "modelID": "claude-sonnet-4-20250514" }
  ]
}
```

### –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```json
{
  "enabled": true,
  "cooldownMs": 60000,
  "fallbackMode": "cycle",
  "maxSubagentDepth": 10,
  "enableSubagentFallback": true,
  "fallbackModels": [
    { "providerID": "anthropic", "modelID": "claude-sonnet-4-20250514" },
    { "providerID": "google", "modelID": "gemini-2.5-pro" },
    { "providerID": "google", "modelID": "gemini-2.5-flash" }
  ],
  "retryPolicy": {
    "maxRetries": 3,
    "strategy": "exponential",
    "baseDelayMs": 1000,
    "maxDelayMs": 30000,
    "jitterEnabled": true,
    "jitterFactor": 0.1,
    "timeoutMs": 60000
  },
  "metrics": {
    "enabled": true,
    "output": {
      "console": true,
      "format": "pretty"
    },
    "resetInterval": "daily"
  },
  "circuitBreaker": {
    "enabled": true,
    "failureThreshold": 5,
    "recoveryTimeoutMs": 60000,
    "halfOpenMaxCalls": 1,
    "successThreshold": 2
  },
  "configReload": {
    "enabled": true,
    "watchFile": true,
    "debounceMs": 1000,
    "notifyOnReload": true
  },
  "dynamicPrioritization": {
    "enabled": true,
    "updateInterval": 10,
    "successRateWeight": 0.6,
    "responseTimeWeight": 0.3,
    "recentUsageWeight": 0.1,
    "minSamples": 3,
    "maxHistorySize": 100
  }
}
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `enabled` | boolean | `true` | –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ |
| `cooldownMs` | number | `60000` | –ü–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è (–º—Å) –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ |
| `fallbackMode` | string | `"cycle"` | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π |
| `fallbackModels` | array | `[]` | –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ |
| `maxSubagentDepth` | number | `10` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤ |
| `enableSubagentFallback` | boolean | `true` | –í–∫–ª—é—á–µ–Ω–∏–µ fallback –¥–ª—è —Å—É–±–∞–≥–µ–Ω—Ç–æ–≤ |

### –†–µ–∂–∏–º—ã Fallback

| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `cycle` | –°–±—Ä–æ—Å –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä —Å –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `stop` | –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –≤—ã–≤–æ–¥ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π |
| `retry-last` | –ü–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–µ–ª–∏, –∑–∞—Ç–µ–º —Å–±—Ä–æ—Å –Ω–∞ –ø–µ—Ä–≤—É—é |

### Retry Policy

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `maxRetries` | number | `3` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ |
| `strategy` | string | `"immediate"` | –°—Ç—Ä–∞—Ç–µ–≥–∏—è: `immediate`, `exponential`, `linear` |
| `baseDelayMs` | number | `1000` | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å) |
| `maxDelayMs` | number | `30000` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å) |
| `jitterEnabled` | boolean | `false` | –°–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è thundering herd |
| `jitterFactor` | number | `0.1` | –§–∞–∫—Ç–æ—Ä jitter (0.1 = ¬±10%) |
| `timeoutMs` | number | ‚Äî | –û–±—â–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

### Circuit Breaker

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `circuitBreaker.enabled` | boolean | `false` | –í–∫–ª—é—á–µ–Ω–∏–µ circuit breaker |
| `circuitBreaker.failureThreshold` | number | `5` | –ö–æ–ª-–≤–æ —Å–±–æ–µ–≤ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ü–µ–ø–∏ |
| `circuitBreaker.recoveryTimeoutMs` | number | `60000` | –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |
| `circuitBreaker.halfOpenMaxCalls` | number | `1` | –ú–∞–∫—Å. –≤—ã–∑–æ–≤–æ–≤ –≤ HALF_OPEN |
| `circuitBreaker.successThreshold` | number | `2` | –£—Å–ø–µ—à–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ü–µ–ø–∏ |

### Hot Reload

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `configReload.enabled` | boolean | `false` | –í–∫–ª—é—á–µ–Ω–∏–µ hot reload |
| `configReload.watchFile` | boolean | `true` | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ |
| `configReload.debounceMs` | number | `1000` | –ó–∞–¥–µ—Ä–∂–∫–∞ debounce (–º—Å) |
| `configReload.notifyOnReload` | boolean | `true` | Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ reload |

## –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫

–ü–ª–∞–≥–∏–Ω —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ rate limit, fallback, retry –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### –í–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

```json
{
  "metrics": {
    "enabled": true,
    "output": {
      "console": true,
      "format": "pretty"
    },
    "resetInterval": "daily"
  }
}
```

### –°–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

#### 1. –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å

–ü—Ä–∏ `"console": true` –º–µ—Ç—Ä–∏–∫–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –ª–æ–≥–∏ OpenCode. –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `pretty`:

```
============================================================
Rate Limit Fallback Metrics
============================================================
Started: 2026-02-11T10:00:00.000Z

Rate Limits:
  anthropic/claude-sonnet-4-20250514:
    Count: 5
    Avg Interval: 3.50s

Fallbacks:
  Total: 3 | Successful: 2 | Failed: 1
  Avg Duration: 1.25s

Model Performance:
  google/gemini-2.5-pro:
    Requests: 10 | Success Rate: 90.0%
    Avg Response: 0.85s
============================================================
```

#### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª

–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤ `"output.file"` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:

```json
{
  "metrics": {
    "enabled": true,
    "output": {
      "console": false,
      "file": "~/.opencode/metrics.json",
      "format": "json"
    }
  }
}
```

–§–∞–π–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: `pretty` (—Ç–µ–∫—Å—Ç), `json`, `csv`.

#### 3. –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±—Ä–æ—Å–∞

| –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `"hourly"` | –°–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–π —á–∞—Å |
| `"daily"` | –°–±—Ä–æ—Å —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `"weekly"` | –°–±—Ä–æ—Å —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é |

## Health Tracker

Health Tracker –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ success rate –∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞. –î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ fallback-–º–æ–¥–µ–ª–∏.

### –í–∫–ª—é—á–µ–Ω–∏–µ

```json
{
  "enableHealthBasedSelection": true,
  "healthPersistence": {
    "enabled": true,
    "path": "~/.opencode/rate-limit-fallback-health.json"
  }
}
```

### –ö–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ

Health Tracker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON-—Ñ–∞–π–ª –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `~/.opencode/rate-limit-fallback-health.json`). –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç:

```json
{
  "models": {
    "anthropic/claude-sonnet-4-20250514": {
      "healthScore": 85,
      "totalRequests": 150,
      "successfulRequests": 140,
      "failedRequests": 10,
      "averageResponseTime": 1200,
      "lastSuccessTime": 1707600000000,
      "consecutiveFailures": 0
    },
    "google/gemini-2.5-pro": {
      "healthScore": 95,
      "totalRequests": 80,
      "successfulRequests": 78,
      "failedRequests": 2,
      "averageResponseTime": 850
    }
  },
  "lastUpdated": 1707600000000
}
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Health Tracker

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `enableHealthBasedSelection` | boolean | `false` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å health score –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–¥–µ–ª–∏ |
| `healthPersistence.enabled` | boolean | `true` | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏ |
| `healthPersistence.path` | string | `~/.opencode/rate-limit-fallback-health.json` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö |
| `healthPersistence.responseTimeThreshold` | number | `2000` | –ü–æ—Ä–æ–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (–º—Å) |
| `healthPersistence.minRequestsForReliableScore` | number | `3` | –ú–∏–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ |

### –†–∞—Å—á—ë—Ç Health Score

–ö–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –æ—Ç 0 –¥–æ 100:
- **–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞** = `(successfulRequests / totalRequests) √ó 100`
- **–®—Ç—Ä–∞—Ñ –∑–∞ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞** = –µ—Å–ª–∏ `avgResponseTime > 2000–º—Å`, –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è `(avgResponseTime - 2000) / 200` –±–∞–ª–ª–æ–≤
- **–®—Ç—Ä–∞—Ñ –∑–∞ —Å–±–æ–∏** = `consecutiveFailures √ó 15` –±–∞–ª–ª–æ–≤ –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–±–æ—Ç–µ –ø–ª–∞–≥–∏–Ω–∞ –≤–∫–ª—é—á–∏—Ç–µ verbose-—Ä–µ–∂–∏–º:

```json
{
  "verbose": true
}
```

–í verbose-—Ä–µ–∂–∏–º–µ –ø–ª–∞–≥–∏–Ω –≤—ã–≤–æ–¥–∏—Ç:
- –¢–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞
- –î–µ—Ç–∞–ª–∏ —Å–ª–∏—è–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ –æ—Ç —É–º–æ–ª—á–∞–Ω–∏–π)
- –°–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker –ø–æ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É Health Tracker
- –ê–∫—Ç–∏–≤–Ω—ã–µ fallback-–æ–ø–µ—Ä–∞—Ü–∏–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ** ‚Äî –ø–ª–∞–≥–∏–Ω —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è rate limit —á–µ—Ä–µ–∑ `session.error`, `message.updated` –∏ `session.status`
2. **Event Lock** ‚Äî –µ–¥–∏–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å–µ—Å—Å–∏—é (TTL 10 —Å–µ–∫) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏
3. **Abort** ‚Äî —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ retry-–º–µ—Ö–∞–Ω–∏–∑–º–∞ OpenCode
4. **Fallback** ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –º–æ–¥–µ–ª—å –∏–∑ fallback-—Å–ø–∏—Å–∫–∞
5. **Cooldown** ‚Äî –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü–ª–∞–≥–∏–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç fallback –ø—Ä–∏ rate limit

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤–∞–ª–∏–¥–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `fallbackModels` –Ω–µ –ø—É—Å—Ç
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `enabled: true`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–ª–∞–≥–∏–Ω–∞

### –í—Å–µ –º–æ–¥–µ–ª–∏ –±—ã—Å—Ç—Ä–æ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—Ç—Å—è

1. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –º–æ–¥–µ–ª–µ–π –≤ `fallbackModels`
2. –£–≤–µ–ª–∏—á—å—Ç–µ `cooldownMs`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `fallbackMode: "cycle"` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
4. –í–∫–ª—é—á–∏—Ç–µ `circuitBreaker` –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

## –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

–û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ [@azumag/opencode-rate-limit-fallback](https://github.com/azumag/opencode-rate-limit-fallback).

## –õ–∏—Ü–µ–Ω–∑–∏—è

[MIT](LICENSE)
